<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        div {
            width: 50%;
            padding-bottom: 1%;
        }
        a {
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
            color: black;
        }
        table {
            width: 100%;
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            text-align: center;
            border: 1px solid gray;
        }
        .stock {
            background-color: black;
        }
    </style>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript">
        // https://gist.github.com/Jezternz/c8e9fafc2c114e079829974e3764db75
        const csvStringToArray = strData =>
        {
            const objPattern = new RegExp(("(\\,|\\r?\\n|\\r|^)(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\\,\\r\\n]*))"),"gi");
            let arrMatches = null, arrData = [[]];
            while (arrMatches = objPattern.exec(strData)){
                if (arrMatches[1].length && arrMatches[1] !== ",")arrData.push([]);
                arrData[arrData.length - 1].push(arrMatches[2] ? 
                    arrMatches[2].replace(new RegExp( "\"\"", "g" ), "\"") :
                    arrMatches[3]);
            }
            return arrData;
        }
    </script>
    <script type="text/javascript">
        function getParam(name) {
            let params = location.search.substr(location.search.indexOf("?") + 1).split("&");

            for (let param of params) {
                let item = param.split("=");

                if (item[0] == name) {
                    return item[1];
                }
            }

            return null;
        }

        let fname = window.location.href.replace("table.html", "data/" + getParam("n") + ".csv");
        let link = atob(decodeURIComponent(getParam("l")));

        window.onload = () => {
            $.ajax({
                url: fname,
                dataType: "text",
                success: (data) => {
                    let csvData = csvStringToArray(data).slice(1, -1);
                    let result = [];
                    let temp = {};
                    let c_time = null;
                    let b_time = null;

                    for (let row of csvData) {
                        let times = row[1].split(":");
                        let c_time = row[0] + " " + times[0] + "시";
                        if (b_time !== null && c_time != b_time) {
                            result.push([b_time, temp]);
                            temp = {};
                        }

                        temp[times[1]] = row[2];

                        b_time = c_time;
                    }

                    result.push([b_time, temp]);

                    let table = "";
                    for (let elem of result) {
                        let text = '<tr><td style="font-weight: bold;">' + elem[0] + "</td>";

                        for (let i = 0; i < 12; i++) {
                            let data = elem[1][("0" + i * 5).slice(-2)];

                            if (typeof data == "undefined") {
                                text += '<td class="stock"></td>';
                            }
                            else if (data == "O") {
                                text += '<td class="stock" style="background-color: #377EB8">O</td>';
                            }
                            else {
                                text += '<td class="stock" style="background-color: #B8374A">X</td>';
                            }
                        }

                        text += '</tr>';

                        table += text;
                    }

                    let tbody = document.getElementsByTagName("tbody")[0];
                    tbody.innerHTML = table;
                    let a = document.getElementsByTagName("a")[0];
                    a.setAttribute("href", "https://kr.iherb.com/pr/" + link + "/" + getParam("n"));
                }
            });
        }
    </script>
</head>
<body>
    <div>
        <a>제품 보기</a>
    </div>
    <div>
        <table>
            <thead>
                <th>시각</th>
                <th>00</th>
                <th>05</th>
                <th>10</th>
                <th>15</th>
                <th>20</th>
                <th>25</th>
                <th>30</th>
                <th>35</th>
                <th>40</th>
                <th>45</th>
                <th>50</th>
                <th>55</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div>
        <button type="button" onclick="openCSV()">csv 파일 열기</button>
    </div>
    <script type="text/javascript">
        function openCSV() {
            console.log(fname);
            location.href = "ms-excel:ofv|u|" + fname;
        }
    </script>
</body>
</html>
